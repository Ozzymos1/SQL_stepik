 SET @AVG_time = (SELECT ROUND(AVG(submission_time - attempt_time), 2) AS AVG_time               
				    FROM student
					     JOIN step_student USING(student_id)
				   WHERE student_name = 'student_59'
						 AND (submission_time - attempt_time) < 3601
				   GROUP BY student_id);
					
WITH get_avr_time(step_id, SUM_time)
     AS (
         SELECT step_id,
                ROUND(SUM(IF((submission_time - attempt_time) < 3601 , 
                             (submission_time - attempt_time), @AVG_time)
							 ),
					  2) AS SUM_time               
		   FROM student
				JOIN step_student USING(student_id)
		  WHERE student_name = 'student_59'
          GROUP BY step_id
         ),
      get_step_time(Студент, Шаг, Результат, Время_попытки, Относительное_время, step_id, submission_time)
      AS (
         SELECT student_name AS Студент, 
				CONCAT(module_id, '.', lesson_position, '.', step_position) AS Шаг,
                result AS Результат,
                IF((submission_time - attempt_time) < 3601 , 
                   (submission_time - attempt_time), 
                   @AVG_time) AS Время_попытки,
                ROUND((IF((submission_time - attempt_time) < 3601 , 
                          (submission_time - attempt_time), 
                          @AVG_time)
					    / SUM_time) * 100,
					  2) AS Относительное_время,
                step_id,
                submission_time
		   FROM student
				JOIN step_student USING(student_id)
				JOIN step USING(step_id)
				JOIN lesson USING(lesson_id)
                JOIN get_avr_time USING(step_id)
		  WHERE student_name = 'student_59'
		  ORDER BY step_id
          )
SELECT Студент, 
       Шаг,
       ROW_NUMBER() OVER (PARTITION BY step_id ORDER BY submission_time) AS Номер_попытки,
       Результат, 
       SEC_TO_TIME(ROUND(Время_попытки, 0)) AS Время_попытки,
       Относительное_время
  FROM get_step_time
 ORDER BY step_id, submission_time;