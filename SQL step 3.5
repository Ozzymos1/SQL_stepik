WITH t2(std_id, lsn, d_t)	
  AS (
		WITH t_1 (std_id, lsn, step_position, diff_time)
		  AS (
				SELECT student_id,
					   CONCAT (module_id, '.', lesson_position, ' ', lesson_name) AS lsn, 
					   step_position,
					   SUM(submission_time - attempt_time) AS diff_time 
				  FROM step_student
					   INNER JOIN step USING (step_id)
					   INNER JOIN lesson USING (lesson_id)
					   INNER JOIN module USING (module_id)
				 WHERE submission_time - attempt_time < 14400
				 GROUP BY student_id, step_id
				 ORDER BY student_id, step_id
			  )
		SELECT std_id, lsn, SUM(diff_time) AS d_t
		  FROM t_1
		 GROUP BY std_id, lsn)
SELECT 	ROW_NUMBER() OVER (ORDER BY ROUND(AVG(d_t)/3600, 2)) AS Номер,
		lsn AS Урок, 
		ROUND(AVG(d_t)/3600, 2) AS Среднее_время
  FROM t2
 GROUP BY lsn;